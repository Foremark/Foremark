# Foremark

Foremark is a technology for writing semi-plain text documents that extends upon the concept of [Markdeep](http://casual-effects.com/markdeep/).

## Features

- Lazy loading — Foremark's code is broken into multiple modules and they are loaded as needed. This is implemented using Webpack's [code splitting feature](https://webpack.js.org/guides/code-splitting/).
- The optional self-contained bundle (`foremark.bundle.js`) includes every required asset in a single `.js` file and does not require an internet connection.
- TODO

## Differences from Markdeep

- Improved internal design — The rendering process is broken into multiple meaningful passes.
- Better browsing experience.
- Built based on modern web technologies. The source code is written in TypeScript and organized into modules.
- Supports flexible input formats ranging from Markdeep-like annotated plain text to explicit markups to meet various needs. In other words, you can write as explicitly as you want to!
- Less unreliable tricks mean less corner cases.
- The recommended file format uses the `.xhtml` extension. Most source tree browsing softwares display XHTML files in the raw code. This is more preferrable to the situation with Markdeep's HTML, which is likely to be inadequately "parsed" and mangled by less-functional viewers such as GitHub and GitLab.
- The true offline experience — the self-contained bundle *really* includes every dependent library like KaTeX for LaTeX typesetting.

## How does it work?

### Step 1 - Expand `<mf-text>` (`mftext.ts`)

Annotations in the text contents of `mf-text` elements are parsed and converted into explicit markups. Non-textual parts are simply passed through, so you can write any part of a text using markups if you want to for some reasons.

The output of this step is a mixture of XHTML and custom elements, which we call Foremark XML. At this point, most constructs are represented using semantic markups, thus the document is ready to be styled using CSS. On the other hand, a few complex constructs are preserved in their original plain text form. Thus, the raw code of the format is still human-read/writable. The next step will further process complex constructs for optimal browser viewing.

### Step 2 - Complex styling (`mfview.ts`)

This step processes custom elements of Foremark XML. The result looks pretty when viewed via a web browser, but the raw code might not no longer retain human-readability.

This step may involve:

- LaTeX equation processing
- Diagrams to SVG conversion
- Footnote/sidenote layouting

### Step 3 - Add user interface (`view.tsx`)

The final HTML is displayed by a web-based viewer application embedded in `foremark.js`, which provides rich functionalities such as a table of contents.

## Directory structure

- `app/` — The source code of this program.
    - `converter/` — Foremark processor.
    - `index.ts` — The entry point of the library.
    - `view/` — The viewer application.
    - `browser.tsx` — The entry point for a web browser.
    - `foremark.ts` — Common definitions of the Foremark format.
    - `utils/` — Utilities.
- `lib/` — Helper code for using external libraries.
- `rust/` — Rust crates.
    - `diagram/` — An interface to Svgbob from the main application.
    - `svgbob/` — Git subtree of <https://github.com/ivanceras/svgbob.git>.
- `examples/` — Example Foremark files.
    - `browser` → `../browser` (symlink)
    - `*.mf.xhtml`

**Intermediate build artifacts:**

- `wasm/` — WebAssembly modules generated by [`wasm-bindgen`](https://github.com/rustwasm/wasm-bindgen).

**NPM package:**

- `browser/` — Foremark processor + viewer to be loaded by Foremark files.
    - `foremark.js` — The main file of the viewer.
    - `foremark-*.js`, `assets/` — Asset files that are loaded on demand.
    - `foremark.bundle.js` — Includes all of the above files in a single large package. (Self-contained bundle)
    - `*.wasm`
    - `licenses.txt` — License information of all software packages included in this directory.
- `dist/` — Provides a Foremark processor library.
    - `index.js` — The entry point of the library.

## Building

Prerequisite:

- [Node.js](https://nodejs.org) ≥ 10
- Yarn (`npm install -g yarn`)
- Rust, a nightly toolchain, which can be installed through [rustup](https://rustup.rs)
- `cargo install` [`wasm-bindgen-cli`](https://rustwasm.github.io/wasm-bindgen/whirlwind-tour/basic-usage.html)
- `cargo install` [`wasm-snip`](https://github.com/rustwasm/wasm-snip)
- [Binaryen](https://github.com/WebAssembly/binaryen) (`brew install binaryen` on Homebrew) including: `wasm-opt`
- `cargo install` [`cargo-license`](https://github.com/onur/cargo-license)
    
```shell
$ yarn install

$ npm run build

# Alternatively, start the Webpack development server:
$ npm run build:wasm
$ npm start -- --open
```

## Meta

- Foremark was originally named Markfront and changed later because the name was taken in many source code hosting services. "Front" was chosen as another adjective indicating a direction. It also refers to the front end of the layered transformation architecture.
