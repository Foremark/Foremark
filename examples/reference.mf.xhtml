<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><body><mf-text><![CDATA[

                  **Foremark Reference Manual**

This document describes the features supported by Foremark.

# Foremark Text

## Header

The first paragraph starting with a boldface text is treated as a header.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
                          **Document title**
A subtitle or whatever deemed appropriate to be displayed near the title
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

## Block quotations

Email-style indenting creates a block quotation:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
> Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
> tempor incididunt ut labore et dolore magna aliqua.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Only an empty line closes a block quotation. This requirement prevents a text editor's hard wrapping functionality from messing up blockquotes:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
Here comes a famous passage:
> Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
tempor incididunt ut labore et dolore magna aliqua.
Still in a block quotation...

No longer in a block quotation.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Block quotes are processed before most kinds of Foremark constructs (even HTML tags!). However, code blocks are processed earlier so that quotation marks inside a code fence are handled as intended:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
> <b>This `<b>` element does not
> have the `>` sign in it.</b>
>
> ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
>
> >
> >
>
> ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


## HTML tags

Foremark Text interprets well-formed HTML tags embedded in a text node as HTML tags. The criterions are chosen to be very strict in order to minimize the chance of misdetections. A HTML tag will not be interpreted as a HTML tag unless all of the following criterias are met:

- It's not inside a code block or an inline code markup. (HTML tags are processed after code blocks and inline code markups.)
- It must use a strictly valid XML syntax, which means:
    - No self-closing tags. `<br/>` (empty-element tag) should be used in place of `<br>`.
    - `<`, `>`, and `"` inside an attribute must be escaped.
    - Every attribute must have a value.
- Only the following XML entities are permitted inside: `&amp;` `&lt;` `&gt;` `&quot;`
- It must not include a XML namespace in the tag name.
- It must not contain any redundant whitespaces in the following places:
    - Between `<` or `</` and the tag name.
    - Between the tag name and `>` of a closing tag.
    - Between `<`, `>`, and `/`.
- If it doesn't use an empty-element tag, then there must exist a matching closing tag.
- The tag name and all attribute names match `/^[a-z][-a-z0-9]*$/` [^tag-name].

[^tag-name]:
    This is a subset of [XML NCName][]. It's quite restricted but still covers all standard HTML and Foremark XML elements.

[XML NCName]: https://www.w3.org/TR/1999/REC-xml-names-19990114/#NT-NCName

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
Valid tag: <br />
Extra whitespaces: < br / > (displayed as "< br / >")
Self-closing: <br> (displayed as "<br>" unless there's `</br>`)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

!!! Note

    The conversion described in this section only applies to HTML tags *embedded as a textual content* (like most of the Foremark Text constructs).
    If HTML tags are not wrapped by `<![CDATA[...]​]>`, they will be parsed by the XHTML parser and converted to XHTML elements before the Foremark text processing takes place.

    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ XML
    <mf-text>
        <!-- The web browser interprets this as a bold element -->
        <b>Bold text</b>

        <!-- Converted to a bold element as a part of the Foremark
             text processing. -->
        &lt;b&gt;Bold text&lt;/b&gt;

        <!-- Equivalent to the previous example. -->
        <![CDATA[ <b>Bold text</b> ]]]><![CDATA[]>
    </mf-text>
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


## Hyperlinks

### Normal hyperlinks

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
[This](https://www.example.com) is a normal Markdown hyperlink.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

### Symbolic hyperlinks

Link targets can be placed out-of-text:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
[**This**][] is a symbolic hyperlink with an implied symbol name.

[This][example] is a symbolic hyperlink with an explicit symbol name.
ALso, notice that the link target can span across multiple lines.
All link breaks within a link target are removed.

[**This**]:  https://www.example.com
[example]:   https://
             www.example.com
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Symbol names are case-sensitive.

A link target definition is only associated with the closest preceding symbolic
hyperlink. A symbolic hyperlink is associated with a link target definition
only if:

- The hyperlink precedes the link target definition.
- There is no hyperlink or link target definiton with an identical symbol name
  between the hyperlink and the link target definition.

A symbolic hyperlink is not formed if no link target could be associated.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
[This][example] is not a hyperlink and is displayed as `[This][example]`.

[This][example] is a hyperlink.

[example]: https://www.example.com
[example]: https://www.example.com/this-link-target-definition-is-ignored
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The association cannot be formed across the boundaries of `<mf-text>`.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ XML
<mf-text>
[This][example] is not a hyperlink and is displayed as `[This][example]`.
</mf-text>
<mf-text>
[example]: https://www.example.com
</mf-text>
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

## Images

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
The pudding face looks like
![alt text (optional)](https://derpicdn.net/img/2018/11/8/1877696/medium.png) or
![alt text (optional)][pudding].

[pudding]: https://derpicdn.net/img/2018/11/8/1877696/medium.png
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Inline images are directly rendered as HTML `<img>` elements.

Read [Symbolic hyperlinks](#foremarktext/hyperlinks/symbolichyperlinks) for more about symbolic hyperlinks (`[pudding]` in the above example).

Use the block syntax to insert an image block using `<mf-figure>`. The block syntax is distinguished by the colon at the end and the addition of an optional figure label:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
The pudding faces are shown below:

![^][alttext](https://derpicdn.net/img/2018/11/8/1877696/medium.png):
    Image block (manually positioned)

![!!][alttext](https://derpicdn.net/img/2018/11/8/1877696/medium.png):
    Image block (manually positioned) but takes entire a row

![!Figure fig1][alttext](https://derpicdn.net/img/2018/11/8/1877696/medium.png):
    Figure (possibly automatically positioned)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The first part (`[^]`, `[!Figure fig1]`) is based on [the floating contents block syntax](#foremarktext/floatingcontents). Sidenote labels (e.g., `[!basenameonly]`) may not be used.

!!! Warning
    `![^][][symbol]:` (A image block with a symbolic name) is not supported.

An image tag optionally include XML attributes:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
![](https://derpicdn.net/img/2018/11/8/1877696/medium.png style="animation: 2000ms _2qw9KkueUdLlzZdwjgAKzl both infinite linear")

![^][](https://derpicdn.net/img/2018/11/8/1877696/medium.png style="animation: 2000ms _2qw9KkueUdLlzZdwjgAKzl both infinite linear"):
    Image caption
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ XML converted
<img src="https://derpicdn.net/img/2018/11/8/1877696/medium.png"
     style="animation: 2000ms _2qw9KkueUdLlzZdwjgAKzl both infinite linear" />

<mf-figure>
    <mf-figure-caption>
        Image caption
    </mf-figure-caption>
    <p>
        <img src="https://derpicdn.net/img/2018/11/8/1877696/medium.png"
             style="animation: 2000ms _2qw9KkueUdLlzZdwjgAKzl both infinite linear" />
    </p>
</mf-figure>
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

## Floating contents

Figures and sidenotes use a (somewhat) unified syntax:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
Let there be some paragraph text[^sidenote].
See [!!Figure fig1] as well as [!Table table]. [!図:fig2]も併せてご覧下さい。
.i ko zgana [!le pixra pe li mupli-pixra]

[^]:
    This is displayed as a sidenote without numbering.

[^sidenote]: Here comes the sidenote.
    Sidenotes are different from figures in the point that
    the first line is not treated specially as a caption.

[!!Figure fig1]: Twily for dummies.
    ![](https://derpicdn.net/img/2013/8/4/391426/large.png)

[!Table table]:
    Since the caption line was left empty, this table has no caption.

    | Elements of Harmony | Pillars of Old Equestria |
    |---------------------|--------------------------|
    | Honesty             | Strength                 |
    | Kindness            | Healing                  |
    | Laughter            | Hope                     |
    | Generosity          | Beauty                   |
    | Loyalty             | Bravery                  |
    | Magic               | Sorcery                  |

[!図:fig2]: Yay.
    ![](https://derpicdn.net/img/2018/8/18/1809969/large.png)

[!le pixra pe li mupli-pixra]: Empty figure.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The part surrounded by brackets is called a *label*. A label consists of the following components:

- A preceding `^` (caret), `!` (exclamation mark), or `!!` (two exclamation marks) specify how the content should be layouted.
    - `^` — The default mode. On a large screen, the content is moved to the side margin.
    - `!` — Translated to `size="large"`. The content is not moved to the side margin and always occupies a row.
    - `!!` — Translated to `size="full"`. The content occupies the maximum available width (including the side margin).

- An optional label identifier, which consists of:

    - An optional number prefix. This serves the purpose of identifying an independent counter for each figure type (e.g., figure/table), and as a text to be displayed before a number. There are two forms:

        - The space-delimited form like `[^Figure fig]` inserts a whitespace between the prefix and a number.
        - The non-space-delimited form like `[^図:fig]` does not insert a whitespace.

      This component is included in the floating element ID along with the base name.

    - A non-empty base name.

      A base name may not include `:` or a whitespace character. Therefore, a label `[^le pixra pe li mupli-pixra]` is interpreted as `le pixra pe li` + `mupli-pixra`[^jbopixra].

The number prefix and the base name together forms a label identifier.

!!! Tip
    The preceding `^` and `!` symbols do not constitute the label identifier. so it's technically possible to refer to a figure with a different symbol. However, it's considered a bad practice because it makes it harder to find a tag using a text editor's search functionality.

!!! Tip
    Although the figure syntax described here can be used for any kinds of contents, it's better to use the image block syntax if you just intend to display an image as a figure.

!!! Note: Differences from Markdeep
    - Figures and sidenotes use the unified system. Still, there is a dedicated syntax for figures.
    - Like Markdeep, sidenotes may contain multiple lines, but they must be indented to be included.
    - Sidenotes can contain multiple paragraphs.

!!! TODO: Yet to be written about...
    - Citations (e.g., `[#Kajiya86]`).
    - Find a way to place table captions above tables but not figure captions.
    - Full width figures (e.g., `[!!Figure fig1]`).

The following table summarizes all forms of labels:

|       Label       | Reference |   Definition  |         `size`        |      `id`     |
|-------------------|-----------|---------------|-----------------------|---------------|
| `[!!]`            | N/A       | `<mf-note>`   | `"full"` [!full-note] | note          |
| `[!]`             | N/A       | `<mf-note>`   | `"large"`             | note          |
| `[^]`             | N/A       | `<mf-note>`   |                       | note          |
| `[!!endnote]`     | ¹         | `<mf-note>`   | `"full"` [!full-note] | `endnote`     |
| `[!endnote]`      | ²         | `<mf-note>`   | `"large"`             | `endnote`     |
| `[^sidenote]`     | ³         | `<mf-note>`   |                       | `sidenote`    |
| `[!!Figure fig1]` | Figure 1  | `<mf-figure>` | `"full"`              | `Figure fig1` |
| `[!Figure fig2]`  | Figure 2  | `<mf-figure>` | `"large"`             | `Figure fig2` |
| `[^Figure fig3]`  | Figure 3  | `<mf-figure>` |                       | `Figure fig3` |
| `[!!図:fig2]`     | 図1       | `<mf-figure>` | `"full"`              | `図:fig2`     |
| `[!図:fig2]`      | 図2       | `<mf-figure>` | `"large"`             | `図:fig2`     |
| `[^図:fig3]`      | 図3       | `<mf-figure>` |                       | `図:fig3`     |

[!full-note]: Does not have an effect. Treated as `"large"`.

- The **Label** column shows the raw source code.
- All reference tags are translated into `<mf-ref>` elements. The **Reference** column shows how a `<mf-ref>` is displayed.
- The contents of a floating element is wrapped by an element shown in the **Definition** column. This element has the attributes shown in the last two columns, **`size`** and **`id`**.

Unreferenced labels are omitted from the output.

[^jbopixra]:
    `«le pixra pe li □»` roughly means "the picture pertaining to number □" in [Lojban][].
    It could be written more concisely as `«le li □ pixra»`, which isn't supported by Foremark at this point.

[Lojban]: https://en.wikipedia.org/wiki/Lojban

## Diagrams

`:::` (three colons) start a diagram (`<mf-diagram>`):

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Foremark
The railroad diagram of Foremark figure label:
:::                                           .---.
:::                                        .->|   |-.
:::      .---------.      .---------.     /   '---'  \    .-----------.      .------------.
::: o--> |"^][><\t"| ---> |"^][><\t"| -*-+            +-> |"^][><\t :"| ---- |"^][><\t :" | -+->o
:::      '---------'   ^  '---------' /   \   .---.  /    '-----------'   ^  '------------' /
:::                     \            /     '->| : |-'                      \               /
:::                      '----------'         '---'                         '-------------'
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

!!! Warning
    Markdeep-style diagrams are not supported.

## Headings

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
First level
===========

Second level
------------

# First level

## Second level

### Third level

#### Fourth level

##### Fifth level

...
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

## Horizontal rules

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Foremark
-----

- - -

_____

_ _ _

*****

* * *
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

## Lists

The following types of lists are supported:

|      Marker     |           Type           |  CSS class  |
|-----------------|--------------------------|-------------|
| `-`             | Unordered list (`<ul>`)  | `minus`     |
| `+`             | Unordered list (`<ul>`)  | `plus`      |
| `*`             | Unordered list (`<ul>`)  | `asterisk`  |
| `[*]` / `- [*]` | Unordered list (`<ul>`)  | `checked`   |
| `[ ]` / `- [ ]` | Unordered list (`<ul>`)  | `unchecked` |
| `42.`           | Ordered list (`<ol>`)    |             |
| `:`             | Definition list (`<dl>`) |             |

A line starting with one of the markers starts a list. The list goes on until a line with the original indentation is encountered:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
- Marker line
  Non-marker lines
    And goes on...
We're out!
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ XML converted
<ul>
    <li class="minus">Marker line
Non-marker lines
  And goes on...</li>
</ul>
<p>We're out!</p>
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Consecutive items with the same list type are merged into one list:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
- Item1
- Item2
1. Item3
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ XML converted
<ul>
    <li class="minus">Item1</li>
    <li class="minus">Item2</li>
</ul>
<ol start="1">
    <li>Item3</li>
</ol>
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

A number in ordered lists *does* matter. A non-sequential number restarts a list to make numbers consistent:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
1. Item1
3. Item2
4. Item3
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ XML converted
<ol start="1">
    <li>Item1</li>
</ol>
<ol start="3">
    <li>Item2</li>
    <li>Item3</li>
</ol>
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Definition lists takes the last line as the caption:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
Asymmetric cryptography
:   An encryption system that uses pairs of keys: public keys
    and private keys.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

## Admonitions

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Foremark
!!! Danger: Can I have your attention please?!
    The message follows...
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ XML converted
<mf-admonition type="Danger">
    <mf-admonition-title>
        Can I have your attention please?!
    </mf-admonition-title>
    <p>
        The message follows...
    </p>
</mf-admonition>
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

A caption line is in one of the following formats:

|        Source       | Admonition type |  Caption  |
|---------------------|-----------------|-----------|
| `!!!`               | (empty)         | (none)    |
| `!!! Type`          | `Type`          | (none)    |
| `!!! Type: Caption` | `Type`          | `Caption` |

## Equations

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Markdown
$$ \Lo(X, \wo) = \Le(X, \wo) + \int_\Omega \Li(X, \wi) ~ f_X(\wi, \wo) ~ | \n \cdot \wi | ~ d\wi $$

Look at an inline equation: $e^{i \pi} + 1 = 0$
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

!!! TODO: Yet to be added...
    - Referencing equations

## Tables

!!! TODO: Yet to be written about...
    Tables

## Paragraphs

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Foremark
Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
consequat.

Duis aute irure dolor in reprehenderit in voluptate velit esse
cillum dolore eu fugiat nulla pariatur.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ XML converted
<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
consequat. </p>
<p>Duis aute irure dolor in reprehenderit in voluptate velit esse
cillum dolore eu fugiat nulla pariatur.</p>
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

## Text styles

|           Source           |       Result      |
|----------------------------|-------------------|
| `**bold**`                 | **bold**          |
| `__bold__`                 | __bold__          |
| `*italic*`                 | *italic*          |
| `_italic_`                 | _italic_          |
| `~~strikethrough~~`        | ~~strikethrough~~ | ]]>
| <code>`inline code`</code> | `inline code`     | <![CDATA[

Formatted text may cross lines, but not paragraphs. Formatting can be applied to a part of words:

|           Source           |                 Result                 |
|----------------------------|----------------------------------------|
| `B is for **B**ooze`       | B is for **B**ooze                     |
| `お前は**もう**死んでいる` | お前は**もう**死んでいる [^no-worddiv] |

[^no-worddiv]:
    Chinese and Japanese are written without word dividers ([わかち書き][]), often causing a headache to writers with certain text formats that require formatting to be applied on per-word basis.

[わかち書き]: https://ja.wikipedia.org/wiki/わかち書き

# Foremark XML

## HTML elements

The following HTML elements are supported and styled appropriately.

- `<h1>` ... `<h9>`
- `<p>`
- `<i>`, `<b>`, `<a>`
- `<code>`
- `<ul>`, `<ol>`, `<ll>`
- `<dl>`, `<dt>`, `<dd>`
- `<br>`

## Document — `<mf>`

~~~~~~~~~~~~xml
<mf>
<mf-title>Document title</mf-title>
</mf>
~~~~~~~~~~~~

- `class="no-sidenotes"` disables sidenotes. All `[^note]` are treated like `[!note]`.

## Header — `<mf-title>`

~~~~~~~~~~~~xml
<mf-title>I Have No Mouth and I Must Scream</mf-title>
<mf-lead>Harlan Ellison</mf-lead>
~~~~~~~~~~~~

`<mf-title>` inserts a document title. `<mf-lead>` inserts a subtitle and if it exists it must follow `<mf-title>`.

*Relevant Foremark Text tags*: `**title**`

## Lists

~~~~~~~~~~~~xml
<ul>
    <li><p>unordered list</p></li>
</ul>
<ol>
    <li><p>ordered list</p></li>
</ol>
<dl>
    <dt><p>caption</p></dt>
    <dd><p>decsription</p></dd>
</dl>
~~~~~~~~~~~~

HTML lists `<ul>` (unordered list), `<ol>` (ordered list), and `<dl>` (definition list) are supported.

`ul > li` may have one of the following CSS classes:

- `checked` indicates that a checked checkbox should be displayed next the item.
- `unchecked` indicates that an unchecked checkbox should be displayed next the item.

*Relevant Foremark Text tags*: `-` `+` `*` `[ ]` `[x]` and more

## Code blocks — `<mf-code>`

~~~~~~~~~~~~xml
<mf-codeblock>
    <mf-code type="Python input">&gt;&gt;&gt; x = [1, 2, 3, 4]
&gt;&gt;&gt; [y * 2 for y in x]</mf-code>
    <mf-code type="none output">[2, 4, 6, 8]</mf-code>
</mf-codeblock>
~~~~~~~~~~~~

**`<mf-code>`** displays a code block with syntax highlighting.
`type` attribute is a space-separated string and the first element indicates the syntax name used for syntax highlighting.

One or more `<mf-code>` elements can be wrapped by **`<mf-codeblock>`**.

!!! Warning
    `<mf-code>` is a block element that should not be confused with `<code>`, which is an inline element used to insert a inline code fragment.

!!! TODO: Yet to be written about...
    The semantics of the rest of `type` attribute value.

*Relevant Foremark Text tags*: `~~~~`–`~~~~`

## LaTeX equations — `<mf-eq>`

~~~~~~~~~~~~xml
<mf-eq-display>
    \Lo(X, \wo) = \Le(X, \wo) + \int_\Omega \Li(X, \wi) ~ f_X(\wi, \wo) ~ | \n \cdot \wi | ~ d\wi
</mf-eq-display>
<p>
    The LLVM target <i>triplet</i> is comprised of <i>five</i> elements.
    Therefore, <mf-eq>3 = 5</mf-eq>.
</p>
~~~~~~~~~~~~

`<mf-eq>` inserts an inline LaTeX equation. Similarly, `<mf-eq-display>` inserts a display LaTeX equation.

*Relevant Foremark Text tags*: `$inline$` `$$display$$`

## Media — `<mf-media>`

~~~~~~~~~~~~~~~ XML
<p>
    <!-- Simply translated to <img> -->
    <mf-media src="https://derpicdn.net/img/2013/8/4/391426/large.png" />
    <!-- DeviantArt oEmbed -->
    <mf-media src="http://fav.me/d89ginp" />
</p>
~~~~~~~~~~~~~~~

`<mf-media>` works almost identically as `<img>` except that it supports a variety of media types through media handlers.

## Floating elements

Figures and sidenotes have the following common attributes:

- The optional **`id`** attribute is used to reference the element from `<mf-ref>`.
- **`size="large"`** prevents the element to be layouted in a confined space like the sidenote margin.
- **`size="full"`** causes the element to occupy the maximum available width. Not supported by sidenotes (because it doesn't make sense!).

!!! Tip
    `size="full"` enables a special styling, which also enables the sidenote margin (even if there aren't actual sidenotes).

### Figures — `<mf-figure>`

~~~~~~~~~~~~xml
<mf-figure id="figureId" counter="table" label="Table {}" size="large">
    <mf-figure-caption>
        Caption
    </mf-figure-caption>
    <p>
        Contents
    </p>
</mf-figure>
~~~~~~~~~~~~

- **`counter`** identifies a counter used to generate a figure number.
- **`label`** specifies the format of the displayed figure label. `{}` is substituted with a number.

If both of `counter` and `label` are omitted but `id` is specified, `counter` and `label` are implied from `id` provided that `id` is in a particular form.

- If `id.match(/(.+):[^ :]+/)`, then `counter` is `$1` and `label` is `$1{}`.
- If `id.match(/(.+) [^ :]+/)`, then `counter` is `$1` and `label` is `$1 {}`.

*Relevant Foremark Text tags*:
- `[^counter basename]: caption` `[!counter basename]: caption`
- `![^counter basename][alt](url): caption` `![!counter basename][alt](url): caption` (generates `<img>` wrapped with `<mf-figure>`)

### Sidenotes/Endnotes — `<mf-note>`

~~~~~~~~~~~~xml
<mf-note id="noteId" size="large">
    <p>
        Contents
    </p>
</mf-note>
~~~~~~~~~~~~

*Relevant Foremark Text tags*: `[^noteId]: contents` `[!noteId]: contents`

### Figure/note references — `<mf-ref>`

~~~~~~~~~~~~xml
<mf-note id="noteId"> ... </mf-note>
<p>
    <mf-ref to="noteId" />
</p>
~~~~~~~~~~~~

*Relevant Foremark Text tags*: `[^noteId]` `[!noteId]`

## Admonitions — `<mf-admonition>`

~~~~~~~~~~~~xml
<mf-admonition type="danger">
    <mf-admonition-title>
        Can I have your attention please?!
    </mf-admonition-title>
    <p>
        The message follows...
    </p>
</mf-admonition>
~~~~~~~~~~~~

*Relevant Foremark Text tag*: `!!!`

## Diagrams — `<mf-diagram>`

]]>
<mf-codeblock>
<mf-code type="xml">&lt;mf-diagram&gt;&lt;![CDATA[<![CDATA[
 .---------.
 |  Server |<------.
 '----+----'       |
      |            |
      | DATA CYCLE |
      v            |
 .---------.  .----+----.
 | Security|  |  File   |
 | Policy  +->| Manager |
 '---------'  '---------'
]]>]]&gt;&lt;/mf-diagram&gt;</mf-code>
</mf-codeblock>
<![CDATA[

*Relevant Foremark Text tags*: `:::`

## Miscellaneous elements

- `<mf-error>` indicates an error encountered while processing `<mf-text>`.

# Viewer application

## Document

A Foremark document is an XHTML file that consolidates Foremark Text/XML markups and a script tag for loading the viewer application.

~~~~~~~~~~~~ XML
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><body><mf-text><![CDATA[

                             **Document title**

Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
consequat.

]]]><![CDATA[]></mf-text> <!-- Foremark footer -->
<script src="../browser/foremark.js" data-rel="foremark" async="async" />
<style>mf-text{white-space:pre-wrap;font-family:monospace}</style></body></html>
~~~~~~~~~~~~

- `html > head > mf` or `html > head > mf-text` represent the content root.
  If `mf-text` is the content root, it will be wrapped by `<mf>` and all attributes are moved to the `<mf>`.
- `html > head > script` with a `data-rel="foremark"` attribute instructs the web browser to load the viewer application. The viewer application locates this tag and uses its `src` attribute as a base path for loading other assets.

!!! Warning

    The viewer application does not support HTML files for various reasons:
     - The web browser's DOM API behaves differently when displaying a HTML file. For example, XHTML preserves the original case for `HTMLElement#tagName` while HTML doesn't.
     - The behavior of `CDATA` in HTML is inconsistent between browsers.

## Configuration

The viewer loads a configuration object from `window.foremarkViewerConfig`. The configuration is typed as following:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ TypeScript
interface ViewerConfig {
    mediaHandlers: { [key: string]: MediaHandler | null; };
}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

There is a default configuration object. The user-provided configuration object is merged into the default configuration object using the **Merge** operation.

The **Merge** operation iterates through the source object's properties. A property name specifies how the property is transferred to the destination object:

- `key` or `key.replace` replaces or creates `destination[key]`.
- `key.merge` applies the **Merge** operation on `destination[key]`. Both of `source[key]` and `destination[key]` must be objects.
- `key.append` appends the elements from an array `source[key]` to `destionation[key]`. Both of `source[key]` and `destination[key]` must be arrays.
- `key.prepend` prepends the elements from an array `source[key]` to `destionation[key]`. Both of `source[key]` and `destination[key]` must be arrays.
- The processing order is unspecified.

A property name optionally include an identifier like `key:ident.merge`. The identifier part is ignored by this operation and only serves to make it possible to have multiple source properties operating on a single destination property. For example, this can be used to prevent one configuration file from overwriting another one's properties:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ JavaScript
// file1.js
var foremarkViewerConfig = Object.assign(window.foremarkViewerConfig, {
    'mediaHandlers:file1.merge': {
        'newhandler1': { /* ... */ },
    },
});

// file2.js
var foremarkViewerConfig = Object.assign(window.foremarkViewerConfig, {
    'mediaHandlers:file2.merge': {
        'newhandler2': { /* ... */ },
    },
});

// The user-supplied configuration object looks like:
{
    'mediaHandlers:file1.merge': { newhandler1: { /* ... */ }, },
    'mediaHandlers:file2.merge': { newhandler2: { /* ... */ }, },
}

// The final configuration object looks like:
{
    mediaHandlers: {
        image: { /* ... */ },
        newhandler1: { /* ... */ },
        newhandler2: { /* ... */ },
    }
}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

## Media handlers

`<mf-media>` elements are processed by the viewer through uses of media handlers.

Media handlers are defined using the configuration system. The `MediaHandler` interface is defined as following:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ TypeScript
interface MediaHandler {
    patterns: Pattern[] | null;
    handler: (e: HTMLElement) => void;
    priority: number;
}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

- `patterns` specifies zero or more URL patterns. A pattern is one of the following:
    - A string.
    - A `RegExp` object.
    - A function that accepts a string as parameter and returns a boolean value.
  If it's `null`, all elements will be matched.

- `handler` specifies a function that processes a media element.

- `priority` specifies a priority value. If there are multiple matching media
  handlers, the one with the highest priority value will be chosen.

The viewer provides several built-in media handlers (`BUILTIN_MEDIA_HANDLERS`). The `.merge` operator can be used to make modifications to the default set.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ JavaScript
var foremarkViewerConfig = Object.assign(window.foremarkViewerConfig, {
    'mediaHandlers.merge': {
        'image': null, // Disable the built-in image handler
        'image.merge': {
            // Or, just change the image handler's URL pattern.
            // The image handler is not a catch-all handler any more.
            patterns: [/\.jpg$/i],
        },
        'myhandler': { // Define a new handler
            /* ... */
        },
    },
});
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

### HTML5 media handlers

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ JavaScript
BUILTIN_MEDIA_HANDLERS = {
    'image': {
        patterns: null,
        handler: handleImageMedia,
        priority: 0,
    },
    'video': {
        patterns: [/\.(mp4|m4v|avi|pg|mov|wmv)$/i],
        handler: handleVideoMedia,
        priority: 20,
    },
    'audio': {
        patterns: [/\.(mp3|ogg|wav|au|opus|m4a|wma)$/i],
        handler: handleAudioMedia,
        priority: 10,
    },
    /* ... */
};
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

These media handlers converts `<mf-media>` to `<img>`, `<video>`, or `<audio>` depending on file extensions and simply copies all XML attributes. `patterns` is `null` for the image handler, thus it serves as a catch-all handler.

## Table of contents

The viewer displays a table of contents that allows quick navigation to various parts of a page.

A table of contents is constructed by looking for heading elements (`h1`, `h2`, ...) in a document.

!!! TODO: Yet to be added...
    Global TOC

]]></mf-text> <!-- Foremark footer -->
<script src="../browser/foremark.js" data-rel="foremark" async="async" />

<style>
mf-code[type="XML converted"] {
    position: relative;
    display: block;
    padding-left: 16px;
    margin-top: 0.5em;
}
mf-code[type="XML converted"]:before {
    content: "XML output";
    font-weight: bold;
    font-size: 90%;
    text-transform: uppercase;
    color: rgba(128, 128, 128, 0.8);
}
mf-code[type="XML converted"]:after {
    position: absolute; content: "";
    left: 4px; top: 0.2em; width: 4px; bottom: 0;
    background: rgba(128, 128, 128, 0.2);
}
</style>

<style>mf-text{white-space:pre-wrap;font-family:monospace}</style></body></html>
